<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.7.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="assets/images/favicon.png">
<title>Testing LSCS Code and Using esw-shell Â· Lower Segment Control System Demonstration</title>
<link rel="stylesheet" href="assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="lib/prettify/prettify.css">
<script src="assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="assets/fonts/font-awesome.css">
<link rel="stylesheet" href="assets/fonts/material-icons.css">
<link rel="stylesheet" href="assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="index.html" title="Lower Segment Control System Demonstration" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Lower Segment Control System Demonstration
</span>
<span class="md-header-nav__topic">
Testing LSCS Code and Using esw-shell
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="index.html" title="Lower Segment Control System Demonstration" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="index.html" title="Lower Segment Control System Demonstration">
Lower Segment Control System Demonstration
</a>
</label>
<ul>
  <li><a href="input-output.html" class="page">Setup Input/Output</a></li>
  <li><a href="LSCSAssembly.html" class="page">LSCS Segments Assembly</a></li>
  <li><a href="LSCSHcd.html" class="page">LSCS Segments HCD</a></li>
  <li><a href="LSCSSimulator.html" class="page">LSCS Simulator and JPL Simulator</a></li>
  <li><a href="Deploy.html" class="page">Segments Assembly and HCD Deployment</a></li>
  <li><a href="TestingAndShell.html" class="active page">Testing LSCS Code and Using esw-shell</a></li>
  <li><a href="Goals.html" class="page">Goals Summary</a></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="TestingAndShell.html#testing-lscs-code-and-using-esw-shell" class="header">Testing LSCS Code and Using esw-shell</a>
  <ul>
    <li><a href="TestingAndShell.html#testing-strategy" class="header">Testing Strategy</a></li>
    <li><a href="TestingAndShell.html#use-of-esw-shell-for-testing" class="header">Use of esw-shell for Testing</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.1.0*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="TestingAndShell.html#testing-lscs-code-and-using-esw-shell" class="header">Testing LSCS Code and Using esw-shell</a>
  <ul>
    <li><a href="TestingAndShell.html#testing-strategy" class="header">Testing Strategy</a></li>
    <li><a href="TestingAndShell.html#use-of-esw-shell-for-testing" class="header">Use of esw-shell for Testing</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#testing-lscs-code-and-using-esw-shell" name="testing-lscs-code-and-using-esw-shell" class="anchor"><span class="anchor-link"></span></a>Testing LSCS Code and Using esw-shell</h1>
<p>This section describes the testing and ties the goals of the demonstration to test verification. It also shows how to use esw-shell to send commands to the assembly.</p>
<h2><a href="#testing-strategy" name="testing-strategy" class="anchor"><span class="anchor-link"></span></a>Testing Strategy</h2>
<p>The strategy here demonstrates one approach to testing. Others rely on mocks to minimize integration tests, but with the level of difficulty in an Assembly and HCD, direct testing is not too difficult.</p>
<p>The approach in this project is that every major class has its own unit tests. As the project progresses higher in the chain more components are involved, which have been unit tested, resulting in a tested component. The following table shows classes and tests:</p>
<table>
  <thead>
    <tr>
      <th>Class </th>
      <th>Test</th>
      <th>Project </th>
      <th>Description </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>SegmentId </td>
      <td>SegmentIdTests</td>
      <td>lscsCommands </td>
      <td>Tests for the SegmentId type, Sector, and SegmentRange </td>
    </tr>
    <tr>
      <td>command classes </td>
      <td>SegmentCommandsTests </td>
      <td>lscsCommands </td>
      <td>Tests for all commands are in this one file. This could be broken out. </td>
    </tr>
    <tr>
      <td>SocketMessage </td>
      <td>SocketMessageTest </td>
      <td>lscsComps </td>
      <td>Tests for JPL message format. </td>
    </tr>
    <tr>
      <td>SocketClientStream </td>
      <td>SocketClientStreamTest </td>
      <td>lscsComps </td>
      <td>Tests the protocol to the simulator </td>
    </tr>
    <tr>
      <td>SegmentActor </td>
      <td>SegmentActorTests </td>
      <td>lscsComps </td>
      <td>Tests basic functionality of Segment Actor talking over client stream </td>
    </tr>
    <tr>
      <td>SegComMonitor </td>
      <td>SegComMonitorTests </td>
      <td>lscsComps </td>
      <td>Tests multi-segment commands and completion </td>
    </tr>
    <tr>
      <td>SegmentsHcdHandlers </td>
      <td>SegmentsHcdTests </td>
      <td>lscsComps </td>
      <td>Tests that HCD receives Setups and sends to segments properly </td>
    </tr>
    <tr>
      <td>SegmentsAssemblyHandlers </td>
      <td>SegmentsAssemblyIntTests </td>
      <td>lscsComps </td>
      <td>Integration tests of end-to-end Assembly receives Setups and sends on to HCD, etc. </td>
    </tr>
    <tr>
      <td>SegmentsAssemblyHandlers </td>
      <td>SegmentsAssemblyTests </td>
      <td>lscsComps </td>
      <td>Tests that Assembly outputs the correct Setup when processing. Uses &ldquo;mock&rdquo; HCD </td>
    </tr>
  </tbody>
</table>
<p>Typically, the tests are run from Intellij. In most cases all tests run without issues, but there are some cases where tests will fail because a previous test is not finished completely. I have not taken the time to wring out all these issues. </p>
<p>There is also the issue with 492 segment tests failing on macOS as mentioned in other places.</p>
<h2><a href="#use-of-esw-shell-for-testing" name="use-of-esw-shell-for-testing" class="anchor"><span class="anchor-link"></span></a>Use of esw-shell for Testing</h2>
<p>ESW-shell is an application that is distributed as part of ESW (it was previously known as csw-shell). It is a command-line interactive user interface that can be used to communicate and control CSW and ESW services and applications. The installation of ESW-shall is described in the ESW documents <a href="https://tmtsoftware.github.io/esw/technical/apps/esw-shell.html">here</a>.</p>
<h3><a href="#setting-up-to-use-esw-shell" name="setting-up-to-use-esw-shell" class="anchor"><span class="anchor-link"></span></a>Setting Up To Use esw-shell</h3>
<p>Setting things up can be a bit complicated. There are a number of considerations when testing:</p>
<ul>
  <li>Do I want to use the JVM-based simulator or the external JPL simulator?</li>
  <li>Am I on Linux?</li>
  <li>Should the JVM-based simulator run from within IDE or not?</li>
  <li>Is csw-services started?</li>
  <li>Should I start the Assembly and HCD separately or in a container?</li>
</ul>
<p>So before using esw-shell successfully, CSW services must be running, a simulator must be running, and the Segments Assembly and HCD must be running. The following will show one approach.</p>
<h3><a href="#install-and-run-csw-services" name="install-and-run-csw-services" class="anchor"><span class="anchor-link"></span></a>Install and Run csw-services</h3>
<p>Follow the instructions <a href="https://tmtsoftware.github.io/csw/apps/cswservices.html">here</a> to install csw-services. Only Location Service is needed, but you must start with an option.</p>
<pre class="prettyprint"><code class="language-scala">csw-services -e
</code></pre>
<p>This starts csw-services with Location Service and Event Service</p>
<h3><a href="#start-the-lscs-simulator" name="start-the-lscs-simulator" class="anchor"><span class="anchor-link"></span></a>Start the LSCS Simulator</h3>
<p>The JVM-based Simulator can be started using <code>sbt</code>:</p>
<pre><code>sbt &quot;lscsComps/runMain m1cs.segments.streams.server.SocketServerStream&quot;
</code></pre>
<p>or </p>
<pre><code>sbt
project lscsComps
run
</code></pre>
<p>And select the SocketServerStream app.</p><div class="callout note "><div class="callout-title">Note</div>
<p>You may also start the simulator on a different machine and use the -DsimulatorHost option to indicate where the simulator is located. This causes the SegmentActor to connect to the port 8023 on the host indicated. This is a good way to keep a simulator runing on a Linux machine.</p></div>
<h3><a href="#starting-the-segments-assembly-and-segments-hcd" name="starting-the-segments-assembly-and-segments-hcd" class="anchor"><span class="anchor-link"></span></a>Starting the Segments Assembly and Segments HCD</h3>
<p>There are component configuration files for standalone HCD and Assembly as well as a container configuration file that includes both. That is the most convenient. Use sbt to start the two in a container as discussed in the deploy section.</p>
<pre><code>sbt &quot;lscs-deploy/runMain m1cs.segments.deploy.SegmentsContainerCmdApp --local src/main/resources/SegmentsContainer.conf&quot;
</code></pre>
<p>or for a remote LSCS Simulator:</p>
<pre><code>sbt &quot;lscs-deploy/runMain m1cs.segments.deploy.SegmentsContainerCmdApp --local src/main/resources/SegmentsContainer.conf -DsimulatorHost=192.168.1.230&quot; 
</code></pre>
<h3><a href="#loading-and-executing-segment-commands" name="loading-and-executing-segment-commands" class="anchor"><span class="anchor-link"></span></a>Loading and Executing Segment Commands</h3>
<p>At this point, CSW services are running, the LSCS Simulator is running, and the Segments Assembly/HCD are running.</p>
<p>The <code>lscsCommands</code> project is created to only include the functions that create Segment Assembly Setups. This means it can be loaded into esw-shell and used to send commands to the Segments Assembly.</p>
<p>The file <code>scripts/commands.sc</code> contains a small introduction that shows how to use <code>esw-shell</code> to send commands to SegmentsAssembly.</p>
<p>By default, esw-shell includes imports of all the major CSW libraries. It also includes some helpers for doing typical operations. First you must import the code needed to create commands. This is present in the example script, so you can copy/paste.</p>
<pre class="prettyprint"><code class="language-scala">// This is needed to resolve TMT libraries (even though they are already present)
import $repo.`https://jitpack.io`

// This loads the lscscommands JAR file.  If you change the version, you must update this also.
interp.load.ivy(&quot;com.github.tmtsoftware.m1cs&quot; %% &quot;lscscommands&quot; % &quot;0.0.1-SNAPSHOT&quot;)

// These imports are needed to send the 10 implemented commands
import m1cs.segments.segcommands._
import m1cs.segments.segcommands.Common._
import Common.CfgLoopModes._
import Common.ControllerModes._
import ACTUATOR.ActuatorModes._
import TARG_GEN_ACT.TargetGenModes._
import TARG_GEN_ACT.TargetShapes._
import CFG_CUR_LOOP.CfgCurLoopMotor._
import SET_LIMIT_ACT.PositionSensors._
import SET_PARAM_ACT.Motors._
import MOVE_WH.MoveTypes._
import MOVE_WH.Torques._
import MOVE_WH.Boosts._
</code></pre>
<p>At this point, any of the commands can be executed. Here is how to send an <code>ACTUATOR</code> command to segment C9.</p>
<pre class="prettyprint"><code class="language-scala">// A test prefix 
val prefix = Prefix(&quot;ESW.test&quot;)

// Create an ACTUATOR command.
val ac = ACTUATOR.toActuator(prefix, Set(1,3)).withMode(TRACK).toSegment(SegmentId(&quot;C9&quot;))

// Create a Command Service for the Segments Assembly. This uses the Location Service to find the Assembly
val segA = assemblyCommandService(&quot;M1CS.segmentsAssembly&quot;)

// Get the Assembly Setup for the command and send it to the Assembly 
val result = segA.submitAndWait(ac.asSetup).get
</code></pre>
<p>The submitAndWait stops and waits until the command is completed. The <code>get</code> on the code waits for the Future to complete and returns the value. </p>
<p>Along the way, the entered lines will print out results (and error messages). For instance the commands above also printed out:</p>
<pre class="prettyprint"><code class="language-scala">val ac = ACTUATOR.toActuator(prefix, Set(1,3)).withMode(TRACK).toSegment(SegmentId(&quot;C9&quot;))
ac: ACTUATOR.toActuator = toActuator(prefix = Prefix(subsystem = ESW, componentName = &quot;test&quot;), actId = Set(1, 3))

val s = ACTUATOR.toActuator(prefix, Set(1,3)).withMode(TRACK).toSegment(SegmentId(&quot;C9&quot;)).asSetup
s: Setup = Setup(
  source = Prefix(subsystem = ESW, componentName = &quot;test&quot;),
  commandName = CommandName(name = &quot;ACTUATOR&quot;),
  maybeObsId = None,
  paramSet = Set(
    Parameter(keyName = &quot;ACT_ID&quot;, keyType = IntKey, items = ArraySeq(1, 3), units = none),
    Parameter(keyName = &quot;MODE&quot;, keyType = ChoiceKey, items = ArraySeq(Choice(name = &quot;TRACK&quot;)), units = none),
    Parameter(keyName = &quot;SegmentId&quot;, keyType = StringKey, items = ArraySeq(&quot;C9&quot;), units = none)
  )
)

// Note that the segmentId does not appear in the command sent to the segment
val c = ACTUATOR.toCommand(s)
c: String = &quot;ACTUATOR ACT_ID=(1,3), MODE=TRACK&quot;
</code></pre>
<p>Commands such as the above can be saved into &ldquo;scripts&rdquo;, that can then be loaded. There is a learning curve to using esw-shell, but usually, the issues are around imports and syntax.</p>
</div>
<div>
<a href="https://github.com/tmtsoftware/tmtsoftware.github.io.git/tree/master/docs/src/main/TestingAndShell.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.1.0*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="Deploy.html" title="Segments Assembly and HCD Deployment" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Segments Assembly and HCD Deployment
</span>
</div>
</a>
<a href="Goals.html" title="Goals Summary" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Goals Summary
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="assets/javascripts/application.583bbe55.js"></script>
<script src="assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"."}})</script>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
