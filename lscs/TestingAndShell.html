<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Testing LSCS Code and Using esw-shell · OSW Examples Documentation</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='paradox docs'/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>

<!--
<link rel="shortcut icon" href="../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>OSW Examples Documentation
</a>
<div class="version-number">
0.1.0
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../commands/index.html" class="page">Commands Example Documentation</a></li>
  <li><a href="../lscs/index.html" class="page">Lower Segment Control System Demonstration</a>
  <ul>
    <li><a href="../lscs/input-output.html" class="page">Setup Input/Output</a></li>
    <li><a href="../lscs/LSCSAssembly.html" class="page">LSCS Segments Assembly</a></li>
    <li><a href="../lscs/LSCSHcd.html" class="page">LSCS Segments HCD</a></li>
    <li><a href="../lscs/LSCSSimulator.html" class="page">LSCS Simulator and JPL Simulator</a></li>
    <li><a href="../lscs/Deploy.html" class="page">Segments Assembly and HCD Deployment</a></li>
    <li><a href="../lscs/TestingAndShell.html" class="active page">Testing LSCS Code and Using esw-shell</a></li>
    <li><a href="../lscs/Goals.html" class="page">Goals and Addressed Issues Summary</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../index.html">OSW Examples Documentation</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>OSW Examples Documentation
</a>
<div class="version-number">
0.1.0
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../commands/index.html" class="page">Commands Example Documentation</a></li>
  <li><a href="../lscs/index.html" class="page">Lower Segment Control System Demonstration</a>
  <ul>
    <li><a href="../lscs/input-output.html" class="page">Setup Input/Output</a></li>
    <li><a href="../lscs/LSCSAssembly.html" class="page">LSCS Segments Assembly</a></li>
    <li><a href="../lscs/LSCSHcd.html" class="page">LSCS Segments HCD</a></li>
    <li><a href="../lscs/LSCSSimulator.html" class="page">LSCS Simulator and JPL Simulator</a></li>
    <li><a href="../lscs/Deploy.html" class="page">Segments Assembly and HCD Deployment</a></li>
    <li><a href="../lscs/TestingAndShell.html" class="active page">Testing LSCS Code and Using esw-shell</a></li>
    <li><a href="../lscs/Goals.html" class="page">Goals and Addressed Issues Summary</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../index.html">OSW Examples Documentation</a></li>
  <li><a href="../lscs/index.html">Lower Segment Control System Demonstration</a></li>
  <li>Testing LSCS Code and Using esw-shell</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#testing-lscs-code-and-using-esw-shell" name="testing-lscs-code-and-using-esw-shell" class="anchor"><span class="anchor-link"></span></a>Testing LSCS Code and Using esw-shell</h1>
<p>This section describes the testing and ties the goals of the demonstration to test verification. It also shows how to use esw-shell to send commands to the assembly.</p>
<h2><a href="#testing-strategy" name="testing-strategy" class="anchor"><span class="anchor-link"></span></a>Testing Strategy</h2>
<p>The strategy here demonstrates one approach to testing. Others rely on mocks to minimize integration tests, but with the level of difficulty in an Assembly and HCD, direct testing is not too difficult.</p>
<p>The approach in this project is that every major class has its own unit tests. As the project progresses higher in the chain more components are involved, which have been unit tested, resulting in a tested component. The following table shows classes and tests:</p>
<table>
  <thead>
    <tr>
      <th>Class </th>
      <th>Test</th>
      <th>Project </th>
      <th>Description </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>SegmentId </td>
      <td>SegmentIdTests</td>
      <td>lscsCommands </td>
      <td>Tests for the SegmentId type, Sector, and SegmentRange </td>
    </tr>
    <tr>
      <td>command classes </td>
      <td>SegmentCommandsTests </td>
      <td>lscsCommands </td>
      <td>Tests for all commands are in this one file. This could be broken out. </td>
    </tr>
    <tr>
      <td>SocketMessage </td>
      <td>SocketMessageTest </td>
      <td>lscsComps </td>
      <td>Tests for JPL message format. </td>
    </tr>
    <tr>
      <td>SocketClientStream </td>
      <td>SocketClientStreamTest </td>
      <td>lscsComps </td>
      <td>Tests the protocol to the simulator </td>
    </tr>
    <tr>
      <td>SegmentActor </td>
      <td>SegmentActorTests </td>
      <td>lscsComps </td>
      <td>Tests basic functionality of Segment Actor talking over client stream </td>
    </tr>
    <tr>
      <td>SegComMonitor </td>
      <td>SegComMonitorTests </td>
      <td>lscsComps </td>
      <td>Tests multi-segment commands and completion </td>
    </tr>
    <tr>
      <td>SegmentsHcdHandlers </td>
      <td>SegmentsHcdTests </td>
      <td>lscsComps </td>
      <td>Tests that HCD receives Setups and sends to segments properly </td>
    </tr>
    <tr>
      <td>SegmentsAssemblyHandlers </td>
      <td>SegmentsAssemblyIntTests </td>
      <td>lscsComps </td>
      <td>Integration tests of end-to-end Assembly receives Setups and sends on to HCD, etc. </td>
    </tr>
    <tr>
      <td>SegmentsAssemblyHandlers </td>
      <td>SegmentsAssemblyTests </td>
      <td>lscsComps </td>
      <td>Tests that Assembly outputs the correct Setup when processing. Uses &ldquo;mock&rdquo; HCD </td>
    </tr>
  </tbody>
</table>
<p>Typically, the tests are run from Intellij. In most cases all tests run without issues, but there are some cases where tests will fail because a previous test is not finished completely. I have not taken the time to wring out all these issues. </p>
<p>There is also the issue with 492 segment tests failing on macOS as mentioned in other places.</p>
<h2><a href="#use-of-esw-shell-for-testing" name="use-of-esw-shell-for-testing" class="anchor"><span class="anchor-link"></span></a>Use of esw-shell for Testing</h2>
<p>ESW-shell is an application that is distributed as part of ESW (it was previously known as csw-shell). It is a command-line interactive user interface that can be used to communicate and control CSW and ESW services and applications. The installation of ESW-shall is described in the ESW documents <a href="https://tmtsoftware.github.io/esw/technical/apps/esw-shell.html">here</a>.</p>
<h3><a href="#setting-up-to-use-esw-shell" name="setting-up-to-use-esw-shell" class="anchor"><span class="anchor-link"></span></a>Setting Up To Use esw-shell</h3>
<p>Setting things up can be a bit complicated. There are a number of considerations when testing:</p>
<ul>
  <li>Do I want to use the JVM-based simulator or the external JPL simulator?</li>
  <li>Am I on Linux?</li>
  <li>Should the JVM-based simulator run from within IDE or not?</li>
  <li>Is csw-services started?</li>
  <li>Should I start the Assembly and HCD separately or in a container?</li>
</ul>
<p>So before using esw-shell successfully, CSW services must be running, a simulator must be running, and the Segments Assembly and HCD must be running. The following will show one approach.</p>
<h3><a href="#locally-install-lscs-jar-file" name="locally-install-lscs-jar-file" class="anchor"><span class="anchor-link"></span></a>Locally Install LSCS JAR File</h3>
<p>This example requires that esw-shell can find and load the lscscommands JAR file. To do that, after building the osw-examples, you must &ldquo;publish&rdquo; the LSCS JAR files locally using the SBT command in the <code>osw-examples</code> directory:</p>
<pre><code>publishLocal
</code></pre>
<p>within the executing <code>sbt</code> or,</p>
<pre class="prettyprint"><code class="language-azure">sbt publishLocal
</code></pre>
<p>in the <code>osw-examples</code> directory.</p>
<p>This creates and copies the JAR files to your <code>ivy</code> repository in the directory ~/.ivy2/local. Now when looking up dependencies, esw-shell will find the lscscommands JAR file. After issuing this command, you can see the JAR files for version 0.1.0 in the directory:</p>
<pre><code>~/.ivy2/local/com.github.tmtsoftware.osw-examples/lscscommands_2.13/0.1.0-SNAPSHOT/jars
</code></pre><div class="callout note "><div class="callout-title">Note</div>
<p>If you are doing this for the first time, the recommendation is to create a terminal window for each of these steps: csw-services, simulator, LSCS container, and esw-shell.</p>
<p>Be sure that you have the CSW environment variables set for the network interface.</p></div>
<h3><a href="#install-and-run-csw-services" name="install-and-run-csw-services" class="anchor"><span class="anchor-link"></span></a>Install and Run csw-services</h3>
<p>Follow the instructions <a href="https://tmtsoftware.github.io/csw/apps/cswservices.html">here</a> to install csw-services. Only Location Service is needed, but you must start with an option.</p>
<pre class="prettyprint"><code class="language-scala">csw-services start -e
</code></pre>
<p>This starts csw-services with Location Service and Event Service</p>
<h3><a href="#start-the-lscs-simulator" name="start-the-lscs-simulator" class="anchor"><span class="anchor-link"></span></a>Start the LSCS Simulator</h3>
<p>The JVM-based Simulator can be started using <code>sbt</code>:</p>
<pre><code>sbt &quot;lscsComps/runMain m1cs.segments.streams.server.SocketServerStream&quot;
</code></pre>
<p>or </p>
<pre><code>sbt
project lscsComps
run
</code></pre>
<p>And select the SocketServerStream app.</p><div class="callout note "><div class="callout-title">Note</div>
<p>You may also start the simulator on a different machine and use the -DsimulatorHost option to indicate where the simulator is located. This causes the SegmentActor to connect to the port 8023 on the host indicated. This is a good way to keep a simulator runing on a Linux machine.</p></div>
<h3><a href="#starting-the-segments-assembly-and-segments-hcd" name="starting-the-segments-assembly-and-segments-hcd" class="anchor"><span class="anchor-link"></span></a>Starting the Segments Assembly and Segments HCD</h3>
<p>There are component configuration files for standalone HCD and Assembly as well as a container configuration file that includes both. That is the most convenient. Use sbt to start the two in a container as discussed in the deploy section.</p>
<pre><code>sbt &quot;lscsDeploy/runMain m1cs.segments.deploy.SegmentsContainerCmdApp --local src/main/resources/SegmentsContainer.conf&quot;
</code></pre>
<p>or for a remote LSCS Simulator:</p>
<pre><code>sbt &quot;lscsDeploy/runMain -DsimulatorHost=192.168.1.230 m1cs.segments.deploy.SegmentsContainerCmdApp --local src/main/resources/SegmentsContainer.conf&quot; 
</code></pre><div class="callout note "><div class="callout-title">Note</div>
<p>The positioning of the -D option is critical. I won&rsquo;t work if it is outside of the quotes and it won&rsquo;t work if it is after the &ndash;local argument&quot;</p></div>
<h3><a href="#loading-and-executing-segment-commands" name="loading-and-executing-segment-commands" class="anchor"><span class="anchor-link"></span></a>Loading and Executing Segment Commands</h3>
<p>At this point, CSW services are running, the LSCS Simulator is running, and the Segments Assembly/HCD are running.</p>
<p>The <code>lscsCommands</code> project is created to only include the functions that create Segment Assembly Setups. This means it can be loaded into esw-shell and used to send commands to the Segments Assembly.</p>
<p>The file <code>scripts/commands.sc</code> contains a small introduction that shows how to use <code>esw-shell</code> to send commands to SegmentsAssembly.</p>
<p>By default, esw-shell includes imports of all the major CSW libraries. It also includes some helpers for doing typical operations. First you must import the code needed to create commands. This is present in the example script, so you can copy/paste.</p>
<pre class="prettyprint"><code class="language-scala">// This is needed to resolve TMT libraries (even though they are already present)
import $repo.`https://jitpack.io`

// This loads the lscscommands JAR file.  If you change the version, you must update this also.
interp.load.ivy(&quot;com.github.tmtsoftware.osw-examples&quot; %% &quot;lscscommands&quot; % &quot;0.1.0-SNAPSHOT&quot;)

// These imports are needed to send the 10 implemented commands
import m1cs.segments.segcommands._
import m1cs.segments.segcommands.Common._
import Common.CfgLoopModes._
import Common.ControllerModes._
import ACTUATOR.ActuatorModes._
import TARG_GEN_ACT.TargetGenModes._
import TARG_GEN_ACT.TargetShapes._
import CFG_CUR_LOOP.CfgCurLoopMotor._
import SET_LIMIT_ACT.PositionSensors._
import SET_PARAM_ACT.Motors._
import MOVE_WH.MoveTypes._
import MOVE_WH.Torques._
import MOVE_WH.Boosts._
</code></pre>
<p>At this point, any of the commands can be executed. Here is how to send an <code>ACTUATOR</code> command to segment C9.</p>
<pre class="prettyprint"><code class="language-scala">// A test prefix 
val prefix = Prefix(&quot;ESW.test&quot;)

// Create an ACTUATOR command.
val ac = ACTUATOR.toActuator(prefix, Set(1,3)).withMode(TRACK).toSegment(SegmentId(&quot;C9&quot;))

// Create a Command Service for the Segments Assembly. This uses the Location Service to find the Assembly
val segA = assemblyCommandService(&quot;M1CS.segmentsAssembly&quot;)

// Get the Assembly Setup for the command and send it to the Assembly 
val result = segA.submitAndWait(ac.asSetup).get
</code></pre>
<p>The submitAndWait stops and waits until the command is completed. The <code>get</code> on the code waits for the Future to complete and returns the value. </p>
<p>Along the way, the entered lines will print out results (and error messages). For instance the commands above also printed out:</p>
<pre class="prettyprint"><code class="language-scala">val ac = ACTUATOR.toActuator(prefix, Set(1,3)).withMode(TRACK).toSegment(SegmentId(&quot;C9&quot;))
ac: ACTUATOR.toActuator = toActuator(prefix = Prefix(subsystem = ESW, componentName = &quot;test&quot;), actId = Set(1, 3))

val s = ACTUATOR.toActuator(prefix, Set(1,3)).withMode(TRACK).toSegment(SegmentId(&quot;C9&quot;)).asSetup
s: Setup = Setup(
  source = Prefix(subsystem = ESW, componentName = &quot;test&quot;),
  commandName = CommandName(name = &quot;ACTUATOR&quot;),
  maybeObsId = None,
  paramSet = Set(
    Parameter(keyName = &quot;ACT_ID&quot;, keyType = IntKey, items = ArraySeq(1, 3), units = none),
    Parameter(keyName = &quot;MODE&quot;, keyType = ChoiceKey, items = ArraySeq(Choice(name = &quot;TRACK&quot;)), units = none),
    Parameter(keyName = &quot;SegmentId&quot;, keyType = StringKey, items = ArraySeq(&quot;C9&quot;), units = none)
  )
)

// Note that the segmentId does not appear in the command sent to the segment
val c = ACTUATOR.toCommand(s)
c: String = &quot;ACTUATOR ACT_ID=(1,3), MODE=TRACK&quot;
</code></pre>
<p>Commands such as the above can be saved into &ldquo;scripts&rdquo;, that can then be loaded. There is a learning curve to using esw-shell, but usually, the issues are around imports and syntax.</p>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/tmtsoftware/osw-examples/tree/master/docs/target/mdoc/lscs/TestingAndShell.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../lscs/Goals.html">Goals and Addressed Issues Summary</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../lscs/TestingAndShell.html#testing-lscs-code-and-using-esw-shell" class="header">Testing LSCS Code and Using esw-shell</a>
  <ul>
    <li><a href="../lscs/TestingAndShell.html#testing-strategy" class="header">Testing Strategy</a></li>
    <li><a href="../lscs/TestingAndShell.html#use-of-esw-shell-for-testing" class="header">Use of esw-shell for Testing</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2022</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '0.1.0', '')});</script>


</html>
